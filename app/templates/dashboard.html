{% extends "base.html" %}

{% block title %}Dashboard - Intelligent System Monitor{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <header class="mb-8">
        <h1 class="text-3xl font-bold text-white mb-2">Intelligent System Monitor</h1>
        <p class="text-gray-400">AI-powered system monitoring with predictive analytics</p>
    </header>

    <!-- Alerts Banner -->
    <div id="alerts-banner" class="mb-6 hidden">
        <div class="bg-red-900/50 border border-red-500 rounded-lg p-4">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <span id="alerts-text" class="text-red-200"></span>
            </div>
        </div>
    </div>

    <!-- Metrics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- CPU Card -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-gray-400 text-sm font-medium">CPU Usage</h3>
                <span id="cpu-trend" class="text-xs px-2 py-1 rounded-full bg-gray-700">--</span>
            </div>
            <div class="flex items-end">
                <span id="cpu-value" class="text-4xl font-bold text-blue-400">--</span>
                <span class="text-gray-500 ml-1 mb-1">%</span>
            </div>
            <div class="mt-4 h-2 bg-gray-700 rounded-full overflow-hidden">
                <div id="cpu-bar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <!-- Memory Card -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-gray-400 text-sm font-medium">Memory Usage</h3>
                <span id="memory-trend" class="text-xs px-2 py-1 rounded-full bg-gray-700">--</span>
            </div>
            <div class="flex items-end">
                <span id="memory-value" class="text-4xl font-bold text-green-400">--</span>
                <span class="text-gray-500 ml-1 mb-1">%</span>
            </div>
            <div class="mt-4 h-2 bg-gray-700 rounded-full overflow-hidden">
                <div id="memory-bar" class="h-full bg-green-500 transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <!-- Disk Card -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-gray-400 text-sm font-medium">Disk Usage</h3>
                <span id="disk-trend" class="text-xs px-2 py-1 rounded-full bg-gray-700">--</span>
            </div>
            <div class="flex items-end">
                <span id="disk-value" class="text-4xl font-bold text-purple-400">--</span>
                <span class="text-gray-500 ml-1 mb-1">%</span>
            </div>
            <div class="mt-4 h-2 bg-gray-700 rounded-full overflow-hidden">
                <div id="disk-bar" class="h-full bg-purple-500 transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <!-- Anomalies Card -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-gray-400 text-sm font-medium">Anomalies Detected</h3>
                <span id="anomaly-status" class="text-xs px-2 py-1 rounded-full bg-green-900 text-green-400">Normal</span>
            </div>
            <div class="flex items-end">
                <span id="anomaly-count" class="text-4xl font-bold text-yellow-400">0</span>
                <span class="text-gray-500 ml-1 mb-1">found</span>
            </div>
            <p id="anomaly-message" class="mt-4 text-sm text-gray-500">Monitoring system behavior...</p>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- CPU Chart -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="text-lg font-medium text-white mb-4">CPU History</h3>
            <canvas id="cpu-chart" height="200"></canvas>
        </div>

        <!-- Memory Chart -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="text-lg font-medium text-white mb-4">Memory History</h3>
            <canvas id="memory-chart" height="200"></canvas>
        </div>
    </div>

    <!-- System Info -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <h3 class="text-lg font-medium text-white mb-4">System Information</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div>
                <span class="text-gray-400">CPU Cores:</span>
                <span id="cpu-cores" class="ml-2 text-white">--</span>
            </div>
            <div>
                <span class="text-gray-400">Total Memory:</span>
                <span id="total-memory" class="ml-2 text-white">--</span>
            </div>
            <div>
                <span class="text-gray-400">Total Disk:</span>
                <span id="total-disk" class="ml-2 text-white">--</span>
            </div>
            <div>
                <span class="text-gray-400">Last Updated:</span>
                <span id="last-updated" class="ml-2 text-white">--</span>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-8 text-center text-gray-500 text-sm">
        <p>Intelligent System Monitor &copy; 2024 | <a href="https://gannsystems.pro" class="text-blue-400 hover:underline">gannsystems.pro</a></p>
    </footer>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Chart configuration
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                grid: { color: 'rgba(255,255,255,0.1)' },
                ticks: { color: '#9CA3AF' }
            },
            x: {
                grid: { display: false },
                ticks: { color: '#9CA3AF', maxTicksLimit: 10 }
            }
        },
        plugins: {
            legend: { display: false }
        },
        elements: {
            point: { radius: 0 },
            line: { tension: 0.4 }
        }
    };

    // Initialize charts
    const cpuChart = new Chart(document.getElementById('cpu-chart'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                data: [],
                borderColor: '#60A5FA',
                backgroundColor: 'rgba(96, 165, 250, 0.1)',
                fill: true
            }]
        },
        options: chartOptions
    });

    const memoryChart = new Chart(document.getElementById('memory-chart'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                data: [],
                borderColor: '#34D399',
                backgroundColor: 'rgba(52, 211, 153, 0.1)',
                fill: true
            }]
        },
        options: chartOptions
    });

    // Format bytes to human readable
    function formatBytes(bytes) {
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        if (bytes === 0) return '0 B';
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
    }

    // Update trend badge
    function updateTrend(elementId, trend) {
        const el = document.getElementById(elementId);
        const colors = {
            increasing: 'bg-red-900 text-red-400',
            decreasing: 'bg-green-900 text-green-400',
            stable: 'bg-gray-700 text-gray-400'
        };
        const icons = {
            increasing: '↑',
            decreasing: '↓',
            stable: '→'
        };
        el.className = `text-xs px-2 py-1 rounded-full ${colors[trend] || colors.stable}`;
        el.textContent = `${icons[trend] || '→'} ${trend}`;
    }

    // Fetch and update metrics
    async function updateMetrics() {
        try {
            const response = await fetch('/api/metrics');
            const metrics = await response.json();

            // Update values
            document.getElementById('cpu-value').textContent = metrics.cpu_percent.toFixed(1);
            document.getElementById('memory-value').textContent = metrics.memory_percent.toFixed(1);
            document.getElementById('disk-value').textContent = metrics.disk_percent.toFixed(1);

            // Update bars
            document.getElementById('cpu-bar').style.width = `${metrics.cpu_percent}%`;
            document.getElementById('memory-bar').style.width = `${metrics.memory_percent}%`;
            document.getElementById('disk-bar').style.width = `${metrics.disk_percent}%`;

            // Update system info
            document.getElementById('cpu-cores').textContent = metrics.cpu_count;
            document.getElementById('total-memory').textContent = formatBytes(metrics.memory_total);
            document.getElementById('total-disk').textContent = formatBytes(metrics.disk_total);
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();

            // Update charts
            const time = new Date().toLocaleTimeString();
            cpuChart.data.labels.push(time);
            cpuChart.data.datasets[0].data.push(metrics.cpu_percent);
            memoryChart.data.labels.push(time);
            memoryChart.data.datasets[0].data.push(metrics.memory_percent);

            // Keep only last 20 points
            if (cpuChart.data.labels.length > 20) {
                cpuChart.data.labels.shift();
                cpuChart.data.datasets[0].data.shift();
                memoryChart.data.labels.shift();
                memoryChart.data.datasets[0].data.shift();
            }

            cpuChart.update('none');
            memoryChart.update('none');

        } catch (error) {
            console.error('Failed to fetch metrics:', error);
        }
    }

    // Fetch predictions and update trends
    async function updatePredictions() {
        try {
            const response = await fetch('/api/predictions');
            const predictions = await response.json();

            updateTrend('cpu-trend', predictions.cpu?.trend);
            updateTrend('memory-trend', predictions.memory?.trend);
            updateTrend('disk-trend', predictions.disk?.trend);
        } catch (error) {
            console.error('Failed to fetch predictions:', error);
        }
    }

    // Fetch anomalies
    async function updateAnomalies() {
        try {
            const response = await fetch('/api/anomalies');
            const data = await response.json();

            const countEl = document.getElementById('anomaly-count');
            const statusEl = document.getElementById('anomaly-status');
            const messageEl = document.getElementById('anomaly-message');

            countEl.textContent = data.anomaly_count || 0;

            if (data.status === 'insufficient_data') {
                statusEl.className = 'text-xs px-2 py-1 rounded-full bg-gray-700 text-gray-400';
                statusEl.textContent = 'Collecting';
                messageEl.textContent = data.message;
            } else if (data.anomaly_count > 0) {
                statusEl.className = 'text-xs px-2 py-1 rounded-full bg-yellow-900 text-yellow-400';
                statusEl.textContent = 'Anomalies';
                messageEl.textContent = `${data.anomaly_count} unusual patterns detected`;
            } else {
                statusEl.className = 'text-xs px-2 py-1 rounded-full bg-green-900 text-green-400';
                statusEl.textContent = 'Normal';
                messageEl.textContent = 'All systems operating normally';
            }
        } catch (error) {
            console.error('Failed to fetch anomalies:', error);
        }
    }

    // Fetch alerts
    async function updateAlerts() {
        try {
            const response = await fetch('/api/alerts');
            const data = await response.json();

            const banner = document.getElementById('alerts-banner');
            const text = document.getElementById('alerts-text');

            if (data.count > 0) {
                banner.classList.remove('hidden');
                text.textContent = data.alerts.map(a => a.message).join(' | ');
            } else {
                banner.classList.add('hidden');
            }
        } catch (error) {
            console.error('Failed to fetch alerts:', error);
        }
    }

    // Initial load and start polling
    updateMetrics();
    updatePredictions();
    updateAnomalies();
    updateAlerts();

    setInterval(updateMetrics, 2000);
    setInterval(updatePredictions, 5000);
    setInterval(updateAnomalies, 10000);
    setInterval(updateAlerts, 5000);
</script>
{% endblock %}
